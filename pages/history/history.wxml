<!-- pages/history/history.wxml -->
<view class="container">
  
  <!-- 1. é¡¶éƒ¨ Tabs åˆ‡æ¢ -->
  <view class="tabs-header">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="switchTab" data-index="0">
      ğŸ“ ç»ƒä¹ è®°å½•
    </view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="switchTab" data-index="1">
      ğŸ“• æˆ‘çš„é”™é¢˜æœ¬
    </view>
  </view>

  <!-- ======================== -->
  <!-- æ¨¡å—ä¸€ï¼šç»ƒä¹ è®°å½• -->
  <!-- ======================== -->
  <view wx:if="{{currentTab === 0}}" class="tab-content">
    <!-- é¡¶éƒ¨ç»Ÿè®¡ -->
    <view class="stats-header">
      <view class="stats-card">
        <text class="stats-label">æ€»ç»ƒä¹ æ¬¡æ•°</text>
        <text class="stats-value">{{totalCount}}</text>
      </view>
      <view class="stats-card">
        <text class="stats-label">å¹³å‡æ­£ç¡®ç‡</text>
        <text class="stats-value">{{averageRate}}%</text>
      </view>
      <view class="stats-card">
        <text class="stats-label">æ€»ç”¨æ—¶</text>
        <text class="stats-value">{{totalTime}}</text>
      </view>
    </view>

    <!-- ç­›é€‰å·¥å…·æ  -->
    <view class="filter-toolbar">
      <!-- ã€ä¿®å¤ç‚¹1ã€‘å¢åŠ äº† enable-flex å±æ€§ -->
      <scroll-view class="grade-filters" scroll-x enable-flex>
        <view class="grade-filter-item {{activeGrade === 0 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="0">å…¨éƒ¨</view>
        <view class="grade-filter-item {{activeGrade === 1 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="1">ä¸€å¹´çº§</view>
        <view class="grade-filter-item {{activeGrade === 2 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="2">äºŒå¹´çº§</view>
        <view class="grade-filter-item {{activeGrade === 3 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="3">ä¸‰å¹´çº§</view>
        <view class="grade-filter-item {{activeGrade === 4 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="4">å››å¹´çº§</view>
        <view class="grade-filter-item {{activeGrade === 5 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="5">äº”å¹´çº§</view>
        <view class="grade-filter-item {{activeGrade === 6 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="6">å…­å¹´çº§</view>
      </scroll-view>
    </view>

    <!-- è®°å½•åˆ—è¡¨ -->
    <view wx:if="{{filteredHistory.length > 0}}">
      <view class="history-list">
        <!-- ã€ä¿®å¤ç‚¹2ã€‘wx:key æ”¹ä¸º idï¼Œå¦‚æœæ²¡æœ‰ id åˆ™ç”¨ unique æˆ– timestamp -->
        <view class="history-item" wx:for="{{filteredHistory}}" wx:key="id">
          <view class="item-header">
            <view class="grade-badge grade-{{item.grade}}">{{item.gradeName}}</view>
            <text class="date">{{formatDate(item.date)}}</text>
          </view>
          
          <view class="item-content">
            <view class="score-section">
              <text class="score">{{item.score}}åˆ†</text>
            </view>
            <view class="details-section">
              <view class="detail-item"><text class="detail-text">âœ… {{item.correctCount}}</text></view>
              <view class="detail-item"><text class="detail-text">âŒ {{item.wrongCount}}</text></view>
              <view class="detail-item"><text class="detail-text">â±ï¸ {{item.time}}</text></view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- æ¸…ç©ºè®°å½• -->
      <view class="clear-section">
        <button class="clear-btn" bindtap="showClearConfirm">æ¸…ç©ºè®°å½•</button>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <icon type="info" size="60" color="#ddd" />
      <text class="empty-desc">è¿˜æ²¡æœ‰ç»ƒä¹ è®°å½•å“¦</text>
    </view>
  </view>

  <!-- ======================== -->
  <!-- æ¨¡å—äºŒï¼šé”™é¢˜æœ¬ -->
  <!-- ======================== -->
  <view wx:if="{{currentTab === 1}}" class="tab-content">
    
    <view wx:if="{{mistakeList.length > 0}}">
      <view class="mistake-header">
        <text class="mistake-count">å…±æ”¶é›† {{mistakeCount}} é“é”™é¢˜</text>
        <view class="clear-mistake-btn" bindtap="clearMistakes">ğŸ—‘ï¸ æ¸…ç©º</view>
      </view>

      <view class="mistake-list">
        <!-- ã€ä¿®å¤ç‚¹3ã€‘wx:key æ”¹ä¸º timestampï¼Œä¿è¯å”¯ä¸€æ€§ï¼Œé˜²æ­¢æ¸²æŸ“å±‚é”™è¯¯ -->
        <block wx:for="{{mistakeList}}" wx:key="timestamp">
          <view class="mistake-card">
            <!-- é¢˜ç›®åŒºåŸŸ -->
            <view class="q-area">
              <text class="q-text">{{item.question}} = ?</text>
              <view class="q-badge">{{item.gradeName || 'é¢˜ç›®'}}</view>
            </view>
            
            <!-- ç­”æ¡ˆå¯¹æ¯” -->
            <view class="ans-area">
              <view class="ans-box wrong">
                <text class="ans-label">ä½ çš„ç­”æ¡ˆ</text>
                <text class="ans-val">{{item.userAnswer}}</text>
              </view>
              <view class="ans-box right">
                <text class="ans-label">æ­£ç¡®ç­”æ¡ˆ</text>
                <text class="ans-val">{{item.correctAnswer}}</text>
              </view>
            </view>

            <!-- æ“ä½œ -->
            <view class="card-footer">
              <text class="wrong-date">{{item.date}}</text>
              <!-- ä¿®å¤ï¼šindexéœ€è¦ä¼ é€’ -->
              <button class="solve-btn" bindtap="removeMistake" data-index="{{index}}">
                âœ¨ æˆ‘å­¦ä¼šäº†
              </button>
            </view>
          </view>
        </block>
      </view>
    </view>

    <!-- é”™é¢˜æœ¬ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <icon type="success" size="80" color="#2ecc71" />
      <text class="empty-title">å¤ªæ£’äº†ï¼</text>
      <text class="empty-desc">é”™é¢˜æœ¬ç©ºç©ºå¦‚ä¹Ÿï¼Œç»§ç»­ä¿æŒï¼</text>
    </view>
  </view>

</view>