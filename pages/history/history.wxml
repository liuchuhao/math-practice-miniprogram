<!-- pages/history/history.wxml -->
<view class="container">
  <!-- 顶部统计 -->
  <view class="stats-header">
    <view class="stats-card">
      <text class="stats-label">总练习次数</text>
      <text class="stats-value">{{totalCount}}</text>
    </view>
    <view class="stats-card">
      <text class="stats-label">平均正确率</text>
      <text class="stats-value">{{averageRate}}%</text>
    </view>
    <view class="stats-card">
      <text class="stats-label">总用时</text>
      <text class="stats-value">{{totalTime}}</text>
    </view>
  </view>

  <!-- 筛选工具栏 -->
  <view class="filter-toolbar">
    <view class="filter-group">
      <text class="filter-label">年级筛选:</text>
      <scroll-view class="grade-filters" scroll-x>
        <view class="grade-filter-item {{activeGrade === 0 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="0">全部</view>
        <view class="grade-filter-item {{activeGrade === 1 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="1">一年级</view>
        <view class="grade-filter-item {{activeGrade === 2 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="2">二年级</view>
        <view class="grade-filter-item {{activeGrade === 3 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="3">三年级</view>
        <view class="grade-filter-item {{activeGrade === 4 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="4">四年级</view>
        <view class="grade-filter-item {{activeGrade === 5 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="5">五年级</view>
        <view class="grade-filter-item {{activeGrade === 6 ? 'active' : ''}}" bindtap="filterByGrade" data-grade="6">六年级</view>
      </scroll-view>
    </view>
    
    <view class="sort-group">
      <text class="filter-label">排序:</text>
      <view class="sort-item {{sortType === 'date' ? 'active' : ''}}" bindtap="changeSort" data-type="date">
        <icon type="time" size="14"></icon>时间
      </view>
      <view class="sort-item {{sortType === 'score' ? 'active' : ''}}" bindtap="changeSort" data-type="score">
        <icon type="sort" size="14"></icon>分数
      </view>
      <view class="sort-item {{sortType === 'rate' ? 'active' : ''}}" bindtap="changeSort" data-type="rate">
        <icon type="barrage" size="14"></icon>正确率
      </view>
    </view>
  </view>

  <!-- 清空记录按钮 -->
  <view class="clear-section">
    <button class="clear-btn" bindtap="showClearConfirm">
      <icon type="clear" size="16"></icon>清空所有记录
    </button>
  </view>

  <!-- 记录列表 -->
  <view wx:if="{{filteredHistory.length > 0}}">
    <view class="history-list">
      <view class="history-item" wx:for="{{filteredHistory}}" wx:key="id" bindtap="viewDetail" data-index="{{index}}">
        <view class="item-header">
          <view class="grade-badge grade-{{item.grade}}">{{item.gradeName}}</view>
          <text class="date">{{formatDate(item.date)}}</text>
        </view>
        
        <view class="item-content">
          <view class="score-section">
            <text class="score">{{item.score}}分</text>
            <text class="total">/ {{item.total}}分</text>
          </view>
          
          <view class="details-section">
            <view class="detail-item">
              <icon type="success" size="14" color="#2ecc71"></icon>
              <text class="detail-text">正确: {{item.correctCount}}</text>
            </view>
            <view class="detail-item">
              <icon type="cancel" size="14" color="#e74c3c"></icon>
              <text class="detail-text">错误: {{item.wrongCount}}</text>
            </view>
            <view class="detail-item">
              <icon type="waiting" size="14" color="#3498db"></icon>
              <text class="detail-text">用时: {{item.time}}</text>
            </view>
          </view>
          
          <view class="rate-section">
            <view class="rate-progress">
              <progress percent="{{item.correctRate || 0}}" stroke-width="6" activeColor="{{getRateColor(item.correctRate)}}" backgroundColor="#eee" />
            </view>
            <text class="rate-text">{{item.correctRate || 0}}%</text>
          </view>
        </view>
        
        <view class="item-footer">
          <text class="time-text">{{formatTime(item.date)}}</text>
          <view class="actions">
            <button class="action-btn review" bindtap="reviewPractice" data-index="{{index}}" catchtap="stopPropagation">
              <icon type="refresh" size="12"></icon>回顾
            </button>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore}}">
      <text class="load-text" bindtap="loadMore">加载更多记录</text>
    </view>
    
    <view class="no-more" wx:if="{{!hasMore}}">
      <text class="no-more-text">没有更多记录了</text>
    </view>
  </view>
  
  <!-- 空状态 -->
  <view class="empty-state" wx:else>
    <icon type="time" size="80" color="#ddd" />
    <text class="empty-title">暂无练习记录</text>
    <text class="empty-desc">快去开始练习吧！</text>
    <button class="empty-btn" bindtap="goPractice">
      <icon type="success" size="16"></icon>开始练习
    </button>
  </view>
</view>